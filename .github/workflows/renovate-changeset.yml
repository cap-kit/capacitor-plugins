name: Renovate Changeset Helper

on:
  pull_request:
    types: [opened, synchronize, labeled]
    branches: [main]

jobs:
  generate-changeset:
    if: >
      github.actor == 'renovate[bot]' &&
      contains(github.event.pull_request.labels.*.name, 'requires-changeset')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Ensure origin/main exists
        run: |
          git fetch origin main:refs/remotes/origin/main || true

      - name: Detect changed packages
        id: packages
        run: |
          set -e

          CHANGED=$(git diff --name-only origin/main...HEAD | grep '^packages/.*/package.json' || true)

          if [ -z "$CHANGED" ]; then
            echo "packages=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          PKGS=$(for f in $CHANGED; do jq -r '.name' "$f"; done | jq -R . | jq -s .)
          echo "packages=$PKGS" >> $GITHUB_OUTPUT

      - name: Create changeset
        if: steps.packages.outputs.packages != '[]'
        run: |
          set -e

          FILENAME=".changeset/renovate-${{ github.event.pull_request.number }}.md"
          TITLE="${{ github.event.pull_request.title }}"

          echo "---" > "$FILENAME"

          for PKG in $(echo '${{ steps.packages.outputs.packages }}' | jq -r '.[]'); do
            echo "'$PKG': patch" >> "$FILENAME"
          done

          echo "---" >> "$FILENAME"
          echo "" >> "$FILENAME"
          echo "$TITLE" >> "$FILENAME"

          cat "$FILENAME"

      - name: Commit changeset
        if: steps.packages.outputs.packages != '[]'
        run: |
          git config user.name "renovate[bot]"
          git config user.email "renovate[bot]@users.noreply.github.com"
          git add .changeset/*.md
          git commit -m "chore(release): add changeset for renovate update"
          git push
